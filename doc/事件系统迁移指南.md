# 事件系统迁移指南

## 概述

本指南将帮助您从旧版本的事件系统迁移到新的优化版本。新的事件系统提供了更好的类型安全、性能优化和功能扩展。

## 主要改进

### 1. 类型安全
- 完整的 TypeScript 类型支持
- 事件数据类型自动推断
- 编译时类型检查

### 2. 性能优化
- 事件优先级支持
- 内存使用监控
- 自动清理过期监听器
- 监听器数量限制

### 3. 功能增强
- 事件命名空间
- 异步事件支持
- 事件等待机制
- 统计信息收集
- 调试模式

### 4. 更好的组件集成
- 自动清理监听器
- 组件级命名空间
- 错误处理改进

## 迁移步骤

### 步骤 1: 更新导入

**旧版本:**
```typescript
import { useEventBus, EVENTS } from '@/composables'
```

**新版本:**
```typescript
import { 
  useEventBus, 
  EVENTS, 
  type EventData, 
  type EventName 
} from '@/composables'
```

### 步骤 2: 基础用法迁移

**旧版本:**
```typescript
const { on, emit, off } = useEventBus()

// 监听事件
const listenerId = on('app:open', (data: any) => {
  console.log('应用打开:', data)
})

// 触发事件
emit('app:open', { appKey: 'finder' })

// 移除监听器
off('app:open', listenerId)
```

**新版本:**
```typescript
const { on, emit, off } = useEventBus()

// 监听事件（类型安全）
const listenerId = on(EVENTS.APP_OPENED, (data) => {
  // data 类型自动推断为 { appKey: string; pid: number }
  console.log('应用打开:', data.appKey, '进程ID:', data.pid)
})

// 触发事件（类型安全）
emit(EVENTS.APP_OPENED, {
  appKey: 'finder',
  pid: 12345
})

// 移除监听器
off(EVENTS.APP_OPENED, listenerId)
```

### 步骤 3: 组件中使用

**旧版本:**
```typescript
export default defineComponent({
  setup() {
    const { on, emit } = useEventBus()
    
    onMounted(() => {
      on('theme:change', handleThemeChange)
    })
    
    // 需要手动清理
    onUnmounted(() => {
      // 手动清理监听器
    })
  }
})
```

**新版本:**
```typescript
export default defineComponent({
  setup() {
    // 自动清理，支持命名空间
    const { on, emit } = useEventBus({
      namespace: 'my-component',
      debugMode: process.env.NODE_ENV === 'development'
    })
    
    onMounted(() => {
      on(EVENTS.THEME_CHANGED, handleThemeChange)
    })
    
    // 组件卸载时自动清理所有监听器
  }
})
```

### 步骤 4: 高级功能使用

**新版本新增功能:**
```typescript
const { 
  on, 
  once, 
  emit, 
  emitAsync, 
  waitFor, 
  offByFilter,
  getStats 
} = useEventBus()

// 优先级监听器
on(EVENTS.APP_FOCUS, handleHighPriority, { priority: 10 })
on(EVENTS.APP_FOCUS, handleLowPriority, { priority: 1 })

// 一次性监听器
once(EVENTS.SYSTEM_READY, () => {
  console.log('系统就绪，只执行一次')
})

// 异步事件
await emitAsync(EVENTS.SYSTEM_READY, undefined)

// 等待事件
try {
  const loginData = await waitFor(EVENTS.USER_LOGIN, 5000)
  console.log('用户登录:', loginData.username)
} catch (error) {
  console.log('等待超时')
}

// 按条件清理监听器
offByFilter({ namespace: 'old-component' })

// 获取统计信息
const stats = getStats()
console.log('事件统计:', stats)
```

## 事件常量迁移

### 旧版本事件常量
```typescript
// constants/index.ts
export const EVENTS = {
  APP_OPEN: 'app:open',
  APP_CLOSE: 'app:close',
  THEME_CHANGE: 'theme:change'
}
```

### 新版本事件常量
```typescript
// composables/useEventBus.ts
export const EVENTS = {
  // 应用事件
  APP_OPEN: 'app:open',
  APP_OPENED: 'app:opened',
  APP_CLOSE: 'app:close',
  APP_CLOSED: 'app:closed',
  
  // 主题事件
  THEME_CHANGE: 'theme:change',
  THEME_CHANGED: 'theme:changed',
  
  // 更多事件...
}
```

## 类型定义迁移

### 新增类型定义
```typescript
// 事件数据映射
export interface EventDataMap {
  [EVENTS.APP_OPENED]: { appKey: string; pid: number }
  [EVENTS.THEME_CHANGED]: { theme: string; previous?: string }
  // 更多事件数据类型...
}

// 类型别名
export type EventName = keyof EventDataMap
export type EventData<T extends EventName> = EventDataMap[T]
```

## 向后兼容

为了确保平滑迁移，新版本提供了向后兼容的方法：

```typescript
// 使用旧版本API
const { onLegacy, emitLegacy } = useEventBus()

// 或者使用专门的兼容函数
const eventBus = useEventBusLegacy()
```

## 性能优化建议

### 1. 使用命名空间
```typescript
// 为不同模块使用不同命名空间
const appEventBus = useEventBus({ namespace: 'app-manager' })
const themeEventBus = useEventBus({ namespace: 'theme-manager' })
```

### 2. 定期清理
```typescript
// 定期清理过期监听器
setInterval(() => {
  eventBus.cleanupStaleListeners(300000) // 清理5分钟前的监听器
}, 60000) // 每分钟检查一次
```

### 3. 监控统计
```typescript
// 监控事件系统性能
const stats = eventBus.getStats()
if (stats.totalListeners > 1000) {
  console.warn('监听器数量过多，考虑清理')
}
```

## 调试和测试

### 启用调试模式
```typescript
const { bus } = useEventBus({ debugMode: true })

// 或者全局配置
bus.setConfig({
  debugMode: process.env.NODE_ENV === 'development',
  maxListeners: 100,
  enableStats: true
})
```

### 运行测试
```typescript
// 导入测试文件
import { runAllTests } from '@/composables/useEventBus.test'

// 运行测试
runAllTests()
```

## 常见问题

### Q: 旧版本的事件监听器还能工作吗？
A: 是的，新版本提供了向后兼容的API，旧代码可以继续工作。

### Q: 如何迁移大量现有代码？
A: 建议分步迁移：
1. 先更新导入和类型定义
2. 逐个组件迁移到新API
3. 最后清理旧的兼容代码

### Q: 新版本的性能如何？
A: 新版本在性能上有显著提升，特别是在大量监听器的场景下。

### Q: 如何处理类型错误？
A: 确保事件数据类型与 `EventDataMap` 中定义的类型匹配，TypeScript 会提供详细的错误信息。

## 最佳实践

1. **使用类型安全的API**：优先使用新的类型安全方法
2. **合理使用命名空间**：为不同模块分配不同的命名空间
3. **设置合适的优先级**：为重要的监听器设置更高的优先级
4. **启用调试模式**：在开发环境中启用调试模式
5. **定期监控性能**：使用统计API监控事件系统的性能
6. **及时清理资源**：利用自动清理功能或手动清理不需要的监听器

## 总结

新的事件系统提供了更好的类型安全、性能和功能。通过逐步迁移，您可以享受到这些改进带来的好处，同时保持代码的稳定性。如果遇到问题，可以参考示例代码或运行测试文件来验证功能。